<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>
<body class="bg-light">

<div class="container my-5">
    <div class="card shadow-sm bg-white p-4">
        <h2 class="mb-4">User Profile</h2>

        <form id="userForm">
            <table class="table table-bordered">
                <tbody>
                <tr>
                    <th>Name</th>
                    <td><input type="text" class="form-control" id="userName" name="name" required></td>
                </tr>
                <tr>
                    <th>Age</th>
                    <td><input type="number" class="form-control" id="userAge" name="age" min="0" required></td>
                </tr>
                <tr>
                    <th>Email</th>
                    <td><input type="email" class="form-control" id="userEmail" name="email" required></td>
                </tr>
                <tr>
                    <th>Password</th>
                    <td><input type="password" class="form-control" id="userPassword" name="password"></td>
                </tr>
                <tr>
                    <th>Home Address</th>
                    <td><input type="text" class="form-control" id="homeAddress" name="homeAddress"></td>
                </tr>
                <tr>
                    <th>Job Address</th>
                    <td><input type="text" class="form-control" id="jobAddress" name="jobAddress"></td>
                </tr>
                <tr>
                    <th>Job Time</th>
                    <td><input type="text" class="form-control" id="jobTime" name="jobTime"></td>
                </tr>
                </tbody>
            </table>

            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="/logout" class="btn btn-dark">Logout</a>
        </form>
    </div>
</div>

<script>
    $(document).ready(function () {

        function loadCurrentUser() {
            $.ajax({
                url: '/api/user',
                type: 'GET',
                dataType: 'json',
                success: function(user) {
                    $('#userName').val(user.name);
                    $('#userAge').val(user.age);
                    $('#userEmail').val(user.email);
                    $('#userPassword').val('');
                    $('#homeAddress').val(user.homeAddress || '');
                    $('#jobAddress').val(user.jobAddress || '');
                    $('#jobTime').val(user.jobTime || '');
                },
                error: function(err) {
                    alert('Ошибка загрузки профиля');
                    console.error(err);
                }
            });
        }

        loadCurrentUser();

        $('#userForm').submit(function(e) {
            e.preventDefault();

            const updatedUser = {
                name: $('#userName').val(),
                age: parseInt($('#userAge').val()),
                email: $('#userEmail').val(),
                homeAddress: $('#homeAddress').val(),
                jobAddress: $('#jobAddress').val(),
                jobTime: $('#jobTime').val()
            };

            const password = $('#userPassword').val();
            if (password && password.trim() !== '') {
                updatedUser.password = password;
            }

            $.ajax({
                url: `/api/user`,
                type: 'PATCH',
                contentType: 'application/json',
                data: JSON.stringify(updatedUser),
                success: function(user) {
                    alert('Профиль успешно обновлен!');
                    loadCurrentUser();
                },
                error: function(err) {
                    alert('Ошибка при обновлении профиля');
                    console.error(err);
                }
            });
        });

    });
</script>

</body>
</html>
